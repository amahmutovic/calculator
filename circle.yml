machine:
  php:
    version: 5.3.3
dependencies:
  override:
    - mkdir -p build/logs
    - composer install --dev --no-interaction
    - pecl install xdebug
    - ls -la ~/.phpenv/versions/$(phpenv version-name)
    - echo "extension=xdebug.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini
test:
  pre:
    - mkdir unit_test_reports
  override:
    - phpunit --log-junit unit_test_reports/sonar-report.xml --coverage-clover unit_test_reports/sonar-report-coverage.xml UnitTest
  post:
    - cp -R unit_test_reports/* $CIRCLE_ARTIFACTS
deployment:
  deploy_staging:
    branch: staging
    commands:
    - heroku maintenance:on --app calculator
    - git push git@heroku.com:calculator.git $CIRCLE_SHA1:refs/heads/master
    - heroku run rake db:migrate --app calculator
    - heroku restart --app calculator
    - heroku maintenance:off --app calculator
